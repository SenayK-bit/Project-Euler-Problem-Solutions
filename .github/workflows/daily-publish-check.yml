name: Daily publish check

# Optional: limit token permissions. If project updates fail, supply a PAT via PROJECT_TOKEN secret.
permissions:
  contents: read
  issues: write

on:
  schedule:
    - cron: '0 8 * * *'  # daily at 08:00 UTC
  workflow_dispatch: {}

jobs:
  check-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Make scripts executable
        run: chmod +x scripts/check_daily_publish.py

      - name: Run daily publish check
        env:
          # Author to check for. Change to your GitHub login or set as repository variable.
          AUTHOR: SenayK-bit
          # How many days back to check (default 1)
          DAYS: '1'
          # Label used on created issues
          ISSUE_LABEL: 'publish-check'
          # Optional: set CLOSE_ISSUES=true to automatically close previous "missing publish" issues when a publish is found
          CLOSE_ISSUES: 'true'
          # Project settings (script can create the project and columns if they don't exist)
          PROJECT_NAME: 'Publish status'              # project board name
          PROJECT_PUBLISHED_COLUMN: 'Published'       # column for successful days
          PROJECT_MISSED_COLUMN: 'Missed'             # column for missed days
          CREATE_PROJECT_IF_MISSING: 'true'           # let the script create the project and columns if needed
          # Token: prefer using a separate PAT (PROJECT_TOKEN) only if project operations fail with GITHUB_TOKEN.
          PROJECT_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          # fallback token used for issue creation (GITHUB_TOKEN is fine)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/check_daily_publish.py \
            --author "$AUTHOR" \
            --days "$DAYS" \
            --label "$ISSUE_LABEL" \
            --close-issues "$CLOSE_ISSUES" \
            --project-name "$PROJECT_NAME" \
            --published-column "$PROJECT_PUBLISHED_COLUMN" \
            --missed-column "$PROJECT_MISSED_COLUMN" \
            --create-project-if-missing "$CREATE_PROJECT_IF_MISSING"
